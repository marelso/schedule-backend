<!DOCTYPE html>
<head>
    <meta charset="UTF-8">
    <title>SSE test</title>
</head>
<body>
    <h1>Server-Sent Events</h1>

    <div id="events"></div>
    <div id="device-container"></div>

    <script>
        function fetchDevice() {
            console.log("Fetching device info . . .")
            fetch(
                'http://localhost:8080/api/v1/device/683668fa90bdabaede1e22d4', {
                    method: 'GET',
                    headers: { 'Accept': '*/*' }
                }
            ).then(res => res.json())
                .then(data => renderDeviceData(data))
                .catch(e=>console.error('Boo...' + e))
        }

        function renderDeviceData(device) {
            const container = document.getElementById('device-container');
            container.innerHTML = '';

            const title = document.createElement('h2');
            title.textContent = `Device: #${device.id} - ${device.name}`;
            container.appendChild(title);

            const ul = document.createElement('ul');
            device.schedules.forEach(schedule => {
                const li = document.createElement('li');
                li.textContent = `Schedule #${schedule.id} start: ${schedule.start} and end at: ${schedule.end}`;
                ul.appendChild(li);
            });
            container.appendChild(ul);
        }

        const eventSource = new EventSource("http://localhost:8080/api/v1/device/683668fa90bdabaede1e22d4/subscribe")

        eventSource.onmessage = (event) => { fetchDevice() }

        eventSource.onerror = (error) => {
            console.error("Error occurred: ", error)
            eventSource.close()
        }

        fetchDevice()
    </script>
</body>